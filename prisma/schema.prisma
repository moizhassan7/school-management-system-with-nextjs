generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---
enum Gender {
  MALE
  FEMALE
  OTHER
  UNSPECIFIED
}

enum FeeType {
  MONTHLY
  ONE_TIME
  ANNUALLY
}

enum InvoiceStatus {
  UNPAID
  PARTIAL
  PAID
  OVERDUE
  CANCELLED // Add this
}

enum ChallanStatus {
  PENDING
  PAID
  CANCELLED
}

enum DiscountType {
  PERCENTAGE
  FLAT
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  ONLINE
  CHEQUE
}

enum Role {
  SUPER_ADMIN
  ADMIN
  TEACHER
  STUDENT
  PARENT
  ACCOUNTANT
}
enum ExamType {
  TERM        // Detailed: Marks per question
  CLASS_TEST  // Simple: Total Obtained / Total Marks
}
model AccountHead {
  id        String   @id @default(cuid())
  name      String
  schoolId  String
  subheads  AccountSubHead[] @relation("AccountHeadSubheads")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, name])
}

 
// --- SCHOOL HIERARCHY ---

model School {
  id        String   @id @default(cuid())
  name      String
  initials  String
  address   String
  email     String
  phone     String
  logoPath  String?
  
  campuses  Campus[]
  users     User[]
  academicYears AcademicYear[]
  feeHeads  FeeHead[] // Relation to Finance
  GradeSystems GradeSystem[] // Relation to Examination

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ClassGroup {
  id           String         @id @default(cuid())
  name         String
  description  String?
  campusId     String
  campus       Campus         @relation(fields: [campusId], references: [id], onDelete: Cascade)
  
  classes      Class[]
  subjectGroups SubjectGroup[]
  
  // --- FIX ADDED HERE ---
  // Link to the grading system (One GradeSystem -> Many ClassGroups)
  gradeSystemId String?       
  gradeSystem   GradeSystem?  @relation(fields: [gradeSystemId], references: [id])
  // ----------------------

  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
}

model SubjectGroup {
  id            String         @id @default(cuid())
  name          String
  description   String?
  classGroupId  String
  classGroup    ClassGroup     @relation(fields: [classGroupId], references: [id], onDelete: Cascade)
  
  subjects      Subject[]
  
  // NEW: Linked to Students, not Classes
  students      StudentRecord[]
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model Class {
  id             String        @id @default(cuid())
  name           String        // e.g. "9-A"
  
  classGroupId   String
  classGroup     ClassGroup    @relation(fields: [classGroupId], references: [id], onDelete: Cascade)
  
  sections       Section[]
  studentRecords StudentRecord[]
  yearRecords    AcademicYearStudentRecord[]
  feeStructures  FeeStructure[]
  
  // --- FIX ADDED HERE ---
  // Opposite relations for the Examination module
  examConfigurations ExamConfiguration[]
  examResults        ExamResult[]
  // ----------------------

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

model StudentRecord {
  id               String   @id @default(cuid())
  userId           String   @unique
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  admissionNumber  String?
  rollNumber       String?  // NEW: Roll Number (Class specific)
  
  admissionDate    DateTime
  
  classId          String?
  myClass          Class?   @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  sectionId        String?
  section          Section? @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  
  // NEW: Student's chosen stream
  subjectGroupId   String?
  subjectGroup     SubjectGroup? @relation(fields: [subjectGroupId], references: [id])
  
  academicYearRecords AcademicYearStudentRecord[]
  parents          Kinship[]

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Campus {
  id          String       @id @default(cuid())
  name        String
  address     String
  phone       String
  email       String?
  schoolId    String
  school      School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  classGroups ClassGroup[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Section {
  id        String @id @default(cuid())
  name      String
  classId   String
  myClass   Class  @relation(fields: [classId], references: [id], onDelete: Cascade)
  students  StudentRecord[]
  yearRecords AcademicYearStudentRecord[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- USER & ACADEMIC RECORDS ---

model User {
  id                String   @id @default(cuid())
  name              String
  email             String   @unique
  passwordHash      String
  city              String?
  religion          String?
  emailVerified     Boolean  @default(false)
  emailVerifiedAt   DateTime?
  profilePath       String?
  schoolId          String
  school            School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  gender            Gender   @default(UNSPECIFIED)
  phone             String?
  address           String?
  deletedAt         DateTime?
  suspended         Boolean  @default(false)
  locked            Boolean  @default(false)
  
  // Relations
  studentRecord     StudentRecord?
  parentRecord      ParentRecord?
  invoices          Invoice[]        // Relation to Finance
  challans          Challan[]        // Relation to Finance
  studentDiscounts  StudentDiscount[] // Relation to Discounts
  examResults       ExamResult[]     // Relation to Examination

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  role Role @default(STUDENT)
  @@index([schoolId])
}

model ParentRecord {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  occupation    String?
  cnic          String?
  officeAddress String?
  
  students      Kinship[]
}

model Kinship {
  id              String        @id @default(cuid())
  studentId       String
  studentRecord   StudentRecord @relation(fields: [studentId], references: [id], onDelete: Cascade)
  parentId        String
  parentRecord    ParentRecord  @relation(fields: [parentId], references: [id], onDelete: Cascade)
  relationship    String        // FATHER, MOTHER, etc.
  isPrimary       Boolean       @default(false)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([studentId, parentId])
}

model Subject {
  id          String   @id @default(cuid())
  name        String
  description String?
  subjectGroupId String
  subjectGroup SubjectGroup @relation(fields: [subjectGroupId], references: [id], onDelete: Cascade)
  examConfigurations ExamConfiguration[]
  examResults ExamResult[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AcademicYear {
  id        String   @id @default(cuid())
  startYear String
  stopYear  String
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  records   AcademicYearStudentRecord[]
  exams     Exam[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, startYear, stopYear])
}

model AcademicYearStudentRecord {
  id              String   @id @default(cuid())
  academicYearId  String
  academicYear    AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  studentRecordId String
  studentRecord   StudentRecord @relation(fields: [studentRecordId], references: [id], onDelete: Cascade)
  classId         String?
  myClass         Class?   @relation(fields: [classId], references: [id], onDelete: Cascade)
  sectionId       String?
  section         Section? @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// --- FINANCE MODULE ---

model FeeHead {
  id          String   @id @default(cuid())
  name        String
  type        FeeType  @default(MONTHLY)
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  accountSubHeadId String?
  accountSubHead   AccountSubHead? @relation(fields: [accountSubHeadId], references: [id])
  structures  FeeStructure[]
  discounts   Discount[]
  invoiceItems InvoiceItem[]
  challanItems ChallanItem[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Challan {
  id            String        @id @default(cuid())
  barcode       String        @unique
  challanNo     String?       @unique
  studentId     String
  student       User          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  issueDate     DateTime      @default(now())
  dueDate       DateTime
  totalAmount   Decimal       @db.Decimal(10, 2)
  paidAmount    Decimal       @default(0) @db.Decimal(10, 2)
  status        ChallanStatus @default(PENDING)
  items         ChallanItem[]
  payments      ChallanPayment[]
  schoolId      String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Optional self-relation to cancel a previous challan
  cancelsChallanId String? @unique
  cancelsChallan   Challan? @relation("ChallanCancellation", fields: [cancelsChallanId], references: [id])
  canceledByChallan Challan? @relation("ChallanCancellation")
}

model ChallanItem {
  id         String   @id @default(cuid())
  amount     Decimal  @db.Decimal(10, 2)
  feeHeadId  String
  feeHead    FeeHead  @relation(fields: [feeHeadId], references: [id])
  challanId  String
  challan    Challan  @relation(fields: [challanId], references: [id], onDelete: Cascade)
}

model ChallanPayment {
  id            String        @id @default(cuid())
  amount        Decimal       @db.Decimal(10, 2)
  date          DateTime      @default(now())
  method        PaymentMethod @default(CASH)
  transactionId String?
  challanId     String
  challan       Challan       @relation(fields: [challanId], references: [id], onDelete: Cascade)
  schoolId      String
  createdAt     DateTime      @default(now())
}

model AccountSubHead {
  id        String   @id @default(cuid())
  name      String
  headId    String?
  head      AccountHead? @relation("AccountHeadSubheads", fields: [headId], references: [id], onDelete: Cascade)
  schoolId  String
  feeHeads  FeeHead[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, name])
}

model FeeStructure {
  id          String   @id @default(cuid())
  amount      Decimal  @db.Decimal(10, 2)
  feeHeadId   String
  feeHead     FeeHead  @relation(fields: [feeHeadId], references: [id], onDelete: Cascade)
  classId     String
  myClass     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  schoolId    String   
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([feeHeadId, classId])
}

model Discount {
  id          String       @id @default(cuid())
  name        String
  value       Decimal      @db.Decimal(10, 2)
  type        DiscountType @default(PERCENTAGE)
  feeHeadId   String
  feeHead     FeeHead      @relation(fields: [feeHeadId], references: [id], onDelete: Cascade)
  schoolId    String
  allocations StudentDiscount[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model StudentDiscount {
  id          String   @id @default(cuid())
  studentId   String
  student     User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  discountId  String
  discount    Discount @relation(fields: [discountId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([studentId, discountId])
}

model Invoice {
  id            String        @id @default(cuid())
  invoiceNo     String        @unique
  studentId     String
  student       User          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  month         Int
  year          Int
  dueDate       DateTime
  totalAmount   Decimal       @db.Decimal(10, 2)
  paidAmount    Decimal       @default(0) @db.Decimal(10, 2)
  status        InvoiceStatus @default(UNPAID)
  items         InvoiceItem[]
  payments      Payment[]     // Relation to Payments
  schoolId      String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model InvoiceItem {
  id             String   @id @default(cuid())
  amount         Decimal  @db.Decimal(10, 2)
  originalAmount Decimal  @db.Decimal(10, 2)
  discountAmount Decimal  @default(0) @db.Decimal(10, 2)
  feeHeadId      String
  feeHead        FeeHead  @relation(fields: [feeHeadId], references: [id])
  invoiceId      String
  invoice        Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

// NEW: Payment Model
model Payment {
  id            String        @id @default(cuid())
  amount        Decimal       @db.Decimal(10, 2)
  date          DateTime      @default(now())
  method        PaymentMethod @default(CASH)
  transactionId String?
  invoiceId     String
  invoice       Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  schoolId      String
  createdAt     DateTime      @default(now())
}



// --- EXAMINATION MODULE ---

// 1. Grading Rules (e.g. "Standard High School Grading")
model GradeSystem {
  id           String   @id @default(cuid())
  name         String   // e.g. "GPA 4.0", "Percentage Based"
  description  String?
  
  schoolId     String
  school       School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  ranges       GradeRange[]
  
  // Which classes follow this system?
  classGroups  ClassGroup[] // Relation to ClassGroup
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// 2. The Rows in the Rule (e.g. A+ is 90-100)
model GradeRange {
  id            String      @id @default(cuid())
  name          String      // e.g. "A+"
  minPercent    Float       // e.g. 90
  maxPercent    Float       // e.g. 100
  gradePoint    Float       // e.g. 4.0
  color         String?     // e.g. "green"
  
  gradeSystemId String
  gradeSystem   GradeSystem @relation(fields: [gradeSystemId], references: [id], onDelete: Cascade)
}
model Exam {
  id             String   @id @default(cuid())
  name           String
  type           ExamType @default(TERM) // NEW
  startDate      DateTime
  endDate        DateTime
  
  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])
  
  schoolId       String
  
  configurations ExamConfiguration[]
  results        ExamResult[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model ExamConfiguration {
  id          String   @id @default(cuid())
  maxMarks    Float    @default(100)
  passMarks   Float    @default(40)
  
  examId      String
  exam        Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  
  subjectId   String
  subject     Subject  @relation(fields: [subjectId], references: [id])
  
  classId     String
  myClass     Class    @relation(fields: [classId], references: [id])

  // NEW: For Term Exams, we define the structure here
  questions   QuestionDefinition[]

  @@unique([examId, subjectId, classId])
}

// NEW: Defines the structure (e.g., Q1, 5 Marks)
model QuestionDefinition {
  id            String   @id @default(cuid())
  label         String   // e.g., "Q1", "MCQ Section", "Essay"
  maxMarks      Float
  order         Int      @default(0)
  
  examConfigId  String
  examConfig    ExamConfiguration @relation(fields: [examConfigId], references: [id], onDelete: Cascade)
  
  marks         QuestionMark[] // The actual marks students get for this question
}

model ExamResult {
  id             String   @id @default(cuid())
  marksObtained  Float    // The calculated total
  status         String?  // PASS / FAIL (Calculated)
  
  examId         String
  exam           Exam     @relation(fields: [examId], references: [id])
  
  studentId      String
  student        User     @relation(fields: [studentId], references: [id])
  
  subjectId      String
  subject        Subject  @relation(fields: [subjectId], references: [id])
  
  classId        String
  myClass        Class    @relation(fields: [classId], references: [id])

  // NEW: Detailed breakdown
  questionMarks  QuestionMark[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([examId, studentId, subjectId])
}

// NEW: Stores the specific mark for a specific question
model QuestionMark {
  id             String   @id @default(cuid())
  obtainedMarks  Float
  
  examResultId   String
  examResult     ExamResult @relation(fields: [examResultId], references: [id], onDelete: Cascade)
  
  questionDefId  String
  questionDef    QuestionDefinition @relation(fields: [questionDefId], references: [id])

  @@unique([examResultId, questionDefId])
}